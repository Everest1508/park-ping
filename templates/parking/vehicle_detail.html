{% extends 'base.html' %}
{% load static %}

{% block title %}{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }} - ParkPing{% endblock %}
{% block page_title %}Vehicle Details{% endblock %}

{% block extra_css %}
<style>
  .qr-code-container {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
  }
  .scan-history-item {
    transition: background-color 0.2s ease;
  }
  .scan-history-item:hover {
    background-color: #f8fafc;
  }
</style>
{% endblock %}

{% block content %}
  <!-- Hidden CSRF token for JavaScript -->
  {% csrf_token %}
  
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center space-x-3">
      <a href="{% url 'parking:vehicle_list' %}" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 transition-colors">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>
        Back to Vehicles
      </a>
    </div>
    <div class="mt-2 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</h1>
        <p class="mt-1 text-sm text-gray-600">License Plate: {{ vehicle.license_plate }}</p>
      </div>
      <div class="flex space-x-2">
        <a href="{% url 'parking:edit_vehicle' vehicle.pk %}" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
          <i data-lucide="edit" class="w-4 h-4 mr-2"></i>
          Edit
        </a>
        <button onclick="confirmDelete('{{ vehicle.pk }}', '{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}')" class="inline-flex items-center px-4 py-2 bg-red-50 border border-red-200 text-red-700 text-sm font-medium rounded-lg hover:bg-red-100 transition-colors">
          <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
          Delete
        </button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Vehicle Information Card -->
      <div class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
          <h3 class="text-base font-semibold text-gray-900">Vehicle Information</h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <p class="text-xs font-medium text-gray-500">Make & Model</p>
              <p class="text-sm font-medium text-gray-900">{{ vehicle.make }} {{ vehicle.model }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">Year</p>
              <p class="text-sm font-medium text-gray-900">{{ vehicle.year }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">License Plate</p>
              <p class="text-sm font-medium text-gray-900">{{ vehicle.license_plate }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">Vehicle Type</p>
              <p class="text-sm font-medium text-gray-900">{{ vehicle.get_vehicle_type_display }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">Color</p>
              <p class="text-sm font-medium text-gray-900">{{ vehicle.color|default:"Not specified" }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">VIN</p>
              <p class="text-sm font-medium text-gray-900">{{ vehicle.vin|default:"Not provided" }}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">Contact Phone</p>
              <p class="text-sm font-medium text-gray-900">
                {% if vehicle.contact_phone %}
                  {{ vehicle.contact_phone.phone_number }}
                {% else %}
                  Not set
                {% endif %}
              </p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500">QR Code Status</p>
              <p class="text-sm font-medium {% if vehicle.is_qr_active %}text-green-600{% else %}text-red-600{% endif %}">
                {% if vehicle.is_qr_active %}Active{% else %}Inactive{% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- QR Code Card -->
      <div class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
          <h3 class="text-base font-semibold text-gray-900">QR Code</h3>
          <div class="flex space-x-2">
            <button onclick="downloadQRCode()" class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
              <i data-lucide="download" class="w-3 h-3 mr-1"></i>
              Download
            </button>
            <button onclick="printQRCode()" class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 rounded-lg text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
              <i data-lucide="printer" class="w-3 h-3 mr-1"></i>
              Print
            </button>
          </div>
        </div>
        <div class="p-6">
          <div class="flex flex-col items-center justify-center">
            {% if vehicle.qr_code %}
              <div class="qr-code-container p-6 mb-4">
                <img src="{{ vehicle.qr_code.url }}" alt="QR Code for {{ vehicle.license_plate }}" class="w-48 h-48 mx-auto">
              </div>
            {% else %}
              <div class="text-center p-6 border-2 border-dashed border-gray-300 rounded-lg mb-4">
                <i data-lucide="qrcode" class="w-12 h-12 text-gray-400 mx-auto mb-2"></i>
                <p class="text-sm text-gray-500">No QR code generated yet</p>
                <a href="{% url 'parking:edit_vehicle' vehicle.pk %}" class="inline-block mt-2 text-sm text-green-600 hover:text-green-800">Generate QR Code</a>
              </div>
            {% endif %}
            
            <div class="w-full max-w-md">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">QR Code Visibility Settings</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs">
                <div class="flex items-center">
                  <i data-lucide="{% if vehicle.show_phone %}check-circle{% else %}x-circle{% endif %}" class="w-4 h-4 mr-2 {% if vehicle.show_phone %}text-green-500{% else %}text-gray-400{% endif %}"></i>
                  <span>Show Phone Number</span>
                </div>
                <div class="flex items-center">
                  <i data-lucide="{% if vehicle.show_name %}check-circle{% else %}x-circle{% endif %}" class="w-4 h-4 mr-2 {% if vehicle.show_name %}text-green-500{% else %}text-gray-400{% endif %}"></i>
                  <span>Show Your Name</span>
                </div>
                <div class="flex items-center">
                  <i data-lucide="{% if vehicle.show_email %}check-circle{% else %}x-circle{% endif %}" class="w-4 h-4 mr-2 {% if vehicle.show_email %}text-green-500{% else %}text-gray-400{% endif %}"></i>
                  <span>Show Email Address</span>
                </div>
                <div class="flex items-center">
                  <i data-lucide="{% if vehicle.show_vehicle_details %}check-circle{% else %}x-circle{% endif %}" class="w-4 h-4 mr-2 {% if vehicle.show_vehicle_details %}text-green-500{% else %}text-gray-400{% endif %}"></i>
                  <span>Show Vehicle Details</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Parking Sessions -->
      {% if active_sessions %}
      <div class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
          <h3 class="text-base font-semibold text-gray-900">Active Parking Sessions</h3>
        </div>
        <div class="p-6">
          <div class="space-y-4">
            {% for session in active_sessions %}
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-sm font-medium text-gray-900">
                    {% if session.location_name %}
                      {{ session.location_name }}
                    {% else %}
                      Unknown Location
                    {% endif %}
                  </p>
                  <p class="text-xs text-gray-500 mt-1">Started: {{ session.start_time|date:"M d, Y h:i A" }}</p>
                  {% if session.location_address %}
                    <p class="text-xs text-gray-500 mt-1">{{ session.location_address }}</p>
                  {% endif %}
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Active
                </span>
              </div>
              {% if session.notes %}
                <div class="mt-3 pt-3 border-t border-gray-100">
                  <p class="text-xs text-gray-700">{{ session.notes }}</p>
                </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Scan History -->
      <div class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
          <h3 class="text-base font-semibold text-gray-900">Recent QR Code Scans</h3>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
            {{ vehicle.scans.count }} total scans
          </span>
        </div>
        <div class="p-6">
          {% if scans %}
            <div class="divide-y divide-gray-200">
              {% for scan in scans %}
                <div class="py-3 scan-history-item">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="text-sm font-medium text-gray-900">
                        {% if scan.scanned_by_ip %}
                          Scanned from {{ scan.scanned_by_ip }}
                        {% else %}
                          Unknown scanner
                        {% endif %}
                      </p>
                      <p class="text-xs text-gray-500 mt-1">{{ scan.scanned_at|date:"M d, Y h:i A" }}</p>
                    </div>
                    <div class="text-right">
                      {% if scan.location_lat and scan.location_lng %}
                        <a href="https://maps.google.com/?q={{ scan.location_lat }},{{ scan.location_lng }}" target="_blank" class="inline-flex items-center text-xs text-blue-600 hover:text-blue-800">
                          <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i>
                          View Location
                        </a>
                      {% else %}
                        <span class="text-xs text-gray-500">No location data</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            {% if scans.count >= 10 %}
              <div class="mt-4 text-center">
                <p class="text-sm text-gray-500">
                  Showing latest 10 scans
                </p>
              </div>
            {% endif %}
          {% else %}
            <div class="text-center py-6">
              <i data-lucide="scan-line" class="w-12 h-12 text-gray-400 mx-auto mb-2"></i>
              <p class="text-sm text-gray-500">No scans yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- QR Code Actions -->
      <div class="bg-white shadow-sm rounded-xl border border-gray-200 p-4">
        <h3 class="text-base font-semibold text-gray-900 mb-4">QR Code Actions</h3>
        <div class="space-y-3">
          <form method="post" action="{% url 'parking:toggle_qr_code' vehicle.pk %}">
            {% csrf_token %}
            <button type="submit" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium {% if vehicle.is_qr_active %}bg-red-50 text-red-700 hover:bg-red-100{% else %}bg-green-50 text-green-700 hover:bg-green-100{% endif %} transition-colors">
              <i data-lucide="{% if vehicle.is_qr_active %}power-off{% else %}power{% endif %}" class="w-4 h-4 mr-2"></i>
              {% if vehicle.is_qr_active %}Deactivate{% else %}Activate{% endif %} QR Code
            </button>
          </form>
          <form method="post" action="{% url 'parking:regenerate_qr_code' vehicle.pk %}">
            {% csrf_token %}
            <button type="submit" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors">
              <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
              Refresh QR Code
            </button>
          </form>
          <a href="{% url 'parking:start_parking_session' vehicle.pk %}" class="w-full flex items-center justify-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-green-700 shadow-sm hover:shadow-md transition-all duration-300">
            <i data-lucide="parking-circle" class="w-4 h-4 mr-2"></i>
            Start Parking Session
          </a>
        </div>
      </div>

      <!-- Vehicle Stats -->
      <div class="bg-white shadow-sm rounded-xl border border-gray-200 p-4">
        <h3 class="text-base font-semibold text-gray-900 mb-4">Vehicle Stats</h3>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-600">Total Scans</span>
            <span class="text-sm font-semibold text-gray-900">{{ vehicle.scans.count }}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-600">Parking Sessions</span>
            <span class="text-sm font-semibold text-gray-900">{{ vehicle.parking_sessions.count }}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-600">Active Sessions</span>
            <span class="text-sm font-semibold text-green-600">{{ active_sessions|length }}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-600">Added On</span>
            <span class="text-sm font-semibold text-gray-900">{{ vehicle.created_at|date:"M d, Y" }}</span>
          </div>
        </div>
      </div>

      <!-- Quick Tips -->
      <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
        <h3 class="text-base font-semibold text-gray-900 mb-3">ðŸ’¡ QR Code Tips</h3>
        <ul class="space-y-2 text-xs text-gray-700">
          <li class="flex items-start">
            <i data-lucide="check" class="w-3 h-3 text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
            Place QR code in a visible location on your dashboard or window
          </li>
          <li class="flex items-start">
            <i data-lucide="check" class="w-3 h-3 text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
            Print at 3x3 inches or larger for easy scanning
          </li>
          <li class="flex items-start">
            <i data-lucide="check" class="w-3 h-3 text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
            Keep your contact information up to date
          </li>
          <li class="flex items-start">
            <i data-lucide="check" class="w-3 h-3 text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
            Start a parking session whenever you park in a new location
          </li>
        </ul>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  // Initialize Lucide icons
  document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
  });

  // Delete confirmation function
  function confirmDelete(vehicleId, vehicleName) {
    Swal.fire({
      title: 'Delete Vehicle?',
      text: `Are you sure you want to delete ${vehicleName}? This action cannot be undone.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#6b7280',
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{% url 'parking:delete_vehicle' 0 %}`.replace('0', vehicleId);
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfToken.value;
          form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
      }
    });
  }

  // Function to download QR code
  function downloadQRCode() {
    {% if vehicle.qr_code %}
      const link = document.createElement('a');
      link.href = '{{ vehicle.qr_code.url }}';
      link.download = 'parkping-qr-{{ vehicle.license_plate }}.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    {% else %}
      alert('No QR code available to download.');
    {% endif %}
  }

  // Function to print QR code
  function printQRCode() {
    {% if vehicle.qr_code %}
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>ParkPing QR Code - {{ vehicle.license_plate }}</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                text-align: center; 
                padding: 20px;
              }
              .qr-container { 
                margin: 20px auto; 
                max-width: 300px;
              }
              .vehicle-info {
                margin-bottom: 20px;
              }
            </style>
          </head>
          <body>
            <h2>ParkPing Vehicle QR Code</h2>
            <div class="vehicle-info">
              <p>{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</p>
              <p>License Plate: {{ vehicle.license_plate }}</p>
            </div>
            <div class="qr-container">
              <img src="{{ vehicle.qr_code.url }}" alt="QR Code" style="width: 100%;">
            </div>
            <p>Scan this code to contact the vehicle owner</p>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    {% else %}
      alert('No QR code available to print.');
    {% endif %}
  }
</script>
{% endblock %}